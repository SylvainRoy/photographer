<!DOCTYPE html>
<html>
  <head>
    <title>Konva Drag and Drop Demo</title>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://unpkg.com/konva@7.2.3/konva.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBO537xsIPtelBtuGlhnx7PmaW_nIjSwyc&callback=initMap&libraries=&v=weekly" defer></script>

    <meta charset="utf-8" />

    <style type="text/css">

      #container {
        border-style: solid;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }

      #map {
          height: 60%;
          width: 100%;
          margin-left: auto;
          margin-right: auto;
          border-style: solid;
      }

      html,
      body {
          height: 90%;
          background-color: #f0f0f0;
          /* margin: 0; */
          /* padding: 0; */
      }

    </style>
  </head>
  <body>

    <center><h1>Where was the photographer?</h1></center>

    <h2>Introduction</h2>
    <p>
        This small tool helps you find the location from which a picture has been taken.
        All you need to know is a few points on the picture that you can locate on a map.
        If you are not sure what to do, set the <a href="#" onclick="demo()">demo</a> and then click on the "Locate" button at the very bottom.
    </p>

    <h2>Step 1 - Load an image and mark known locations</h2>
    <p>Select a photo and locate at least 3 points that you can locate on the map. Please be as acurate as possible!</p>
    <input type="file" name="inpfile" id="inpFile">
    <div id="container"></div>
    
    <h2>Step 2 - Mark same known locations on the map</h2>
    <p>Locate the same points on the map below.</p>
    <div id="map"></div>

    <h2>Step 3:</h2>
    <p>well... Just click! A new marker will appear on the map to indicate the computed location of the photographer.</p>
    <div ><button onclick="locatePhotographer()">Locate</button></div>

    <h2>About this tool</h2>
    <p>
        Worried about privacy? Only the coordinates of the points on the picture (x, y) and on the map (latitude, longitude) are sent to the server.
        The picture never leaves your browser.
    </p>
    <p>
        This is an open source toy project.
        The code can be found on GitHub. TODO
        The server (which computes the location of the photographer) provides a JSon API that can be called directly.
        Just check what your browser is doing in the background to find out.
    </p>
    <p>
        Nope... I am definitively not a UX expert...
    </p>
    <p>This tool comes with no guarantee.</p>


    <!-- Loading and marking the picture -->
    <script>     
      
      //
      // Set up the picture viewer/marker
      //
      var container = document.getElementById('container');
      var stage = new Konva.Stage({
        container: 'container',
        width: container.clientWidth,
        height: 100,
      });
      var picLayer = new Konva.Layer();
      var markerLayer = new Konva.Layer();
      stage.add(picLayer);
      stage.add(markerLayer);

      //
      // Let the user load a picture in the marking area.
      //
      const inpFile = document.getElementById("inpFile");
      inpFile.addEventListener("change", function() {
        // Remove any marker left
        markerLayer.destroyChildren();
        markerLayer.draw();
        // Load picture
        const file = this.files[0];
        if (!file) {
          return; // The user canceled
        }
        const reader = new FileReader();
        reader.addEventListener("load", function() {
          Konva.Image.fromURL(this.result, function (pic) {
            // Update dimension of the picture area
            stage.width(container.clientWidth);
            stage.height(container.clientWidth * pic.height() / pic.width());
            // Load picture in background
            pic.setAttrs({
              x: 0,
              y: 0,
              width: stage.width(),
              height: stage.height(),
            });
            picLayer.add(pic);
            picLayer.draw();
          });
        });
        reader.readAsDataURL(file);
      });      
      
      //
      // Detect left click on the picture to add a marker
      //      
      stage.on('click', function(e) {
        if (e.target.className == "Image" && e.evt.button == 0) {
          x = e.evt.layerX;
          y = e.evt.layerY;
          addPictureMarker(x, y);
        }
      });

      //
      // Detect right click on the picture to delete a marker
      //
      stage.on('contextmenu', function (e) {
        // prevent default behavior
        e.evt.preventDefault();
        if (e.target === stage || e.target.className == "Image") {
          return;
        };
        // move up in the hierarchy to (possibly) find a label element (rather than one of its subelement)
        curTarget = e.target;
        while (curTarget.className != "Label") {
          if (!curTarget.parent) {
            return;
          }
          curTarget = curTarget.parent;
        }
        removePictureMarker(curTarget);
      });

      //
      // Add a marker on the picture
      //
      function addPictureMarker(x, y) {
        console.log(`pictureMarker: ${x} / ${stage.width()}, ${y} / ${stage.height()}`)
        var tooltip = new Konva.Label({
          x: x,
          y: y,
          opacity: 0.75,
          draggable: true,
        });
        tooltip.add(
          new Konva.Tag({
            fill: 'black',
            pointerDirection: 'down',
            pointerWidth: 18,
            pointerHeight: 20,
          })
        );
        tooltip.add(
          new Konva.Text({
            text: "?",
            fontFamily: 'Calibri',
            fontSize: 18,
            padding: 5,
            fill: 'white',
          })
        );
        // add cursor styling and detect mouse over marker
        tooltip.on('mouseover', function () {
          document.body.style.cursor = 'pointer';
        });
        tooltip.on('mouseout', function () {
          document.body.style.cursor = 'default';
        });
        // Draw the marker
        markerLayer.add(tooltip);
        renamePictureMarkers();
        markerLayer.draw();
        return tooltip;
      };
      
      //
      // Remove a marker from the picture
      //
      function removePictureMarker(marker) {
        marker.destroy();
        renamePictureMarkers();
        markerLayer.draw();
      };
      
      //
      // Rename all markers from left to rigth
      //
      function renamePictureMarkers() {
        let i = 0;
        const labels = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        markerLayer.getChildren().slice(0).sort(function (a, b) {
          return a.getPosition().x - b.getPosition().x;
        }).forEach(marker => {
          if (marker.getText()) {
            marker.getText().text(labels[i++]);
          };
        });
      };

    </script>

    <!-- Loading and marking the map -->
    <script>
      var map;
      var mapMarkers = []; // the list of markers added on the map
            
      //
      // Init the map
      //
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 12,
          center: { lat: 45.83550785027975, lng: 6.863880441774906 },
        });
        // Add a marker when the map is clicked.
        google.maps.event.addListener(map, "click", (event) => {
          addMarker(event.latLng, map);
        });
      }
      
      //
      // Adds a marker to the map.
      //
      function addMarker(location, map) {
        var marker = new google.maps.Marker({
          position: location,
          label: "Z",
          draggable:true,
          map: map,
        });
        // Right click on marker deletes it.
        marker.addListener("contextmenu", function(event) {
          m = this;
          mapMarkers = mapMarkers.filter(function(item) {
            return item !== m;
          });
          this.setMap(null);
          renameMapMarkers();
        });
        // Register marker.
        mapMarkers.push(marker);
        // Ensure they are named in contiguous alpha order
        renameMapMarkers();
      }

      //
      // Rename markers to ensure contiguous alpha order
      //
      function renameMapMarkers() {
        let i = 0;
        const labels = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        mapMarkers.forEach(marker => {
          marker.setLabel(labels[i++]);          
        });
      }

    </script>

    <!-- Calling the server -->
    <script>
      //
      // Collect the data from the page, call the server and add a marker for the photographer on the map.
      //
      function locatePhotographer() {

          // Check inputs
          numPicMarkers = markerLayer.getChildren().length;
          numMapMarkers = mapMarkers.length;
          if (numPicMarkers < 3) {
              alert("At least three markers are required on the picture!");
              return
          }
          if (numMapMarkers < 3) {
              alert("At least three markers are required on the map!");
              return
          }
          if (numMapMarkers != numPicMarkers) {
              alert("The number of markers on the picture and on the map must be equal!");
              return
          }

          // Build message payload
          const projections = markerLayer
              .getChildren()
              .map(function (marker) {return marker.getPosition().x})
              .sort(function (a, b) {return a - b});
          const latlngs = mapMarkers
              .map(function(marker) {return [marker.position.lat(), marker.position.lng()]});
          const payload = {
              projections: projections,
              latlngs: latlngs
          };

          // Call the server
          fetch('../locate/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
          })
          .then(response => response.json())
          .then(data => {
              console.log('Recv:', data);
              if (data.status != "ok") {
                  alert(data.status);
                  return
              }
              // Add a marker at the photographer location.
              loc = {lat: data.location[0], lng: data.location[1]};
              var marker = new google.maps.Marker({
                  position: loc,
                  label: "X",
                  draggable:false,
                  map: map,
              });
              // Right click on marker deletes it.
              marker.addListener("contextmenu", function(event) {
                  m = this;
                  mapMarkers = mapMarkers.filter(function(item) {
                      return item !== m;
                  });
                  this.setMap(null);
              });
              // Center map on photographer.
              map.setCenter(loc)
          })
          .catch((error) => {
              console.error('Error:', error);
          });
      };
    </script>

  </body>
</html>
