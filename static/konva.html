<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@7.2.3/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Drag and Drop Demo</title>
    <style>
      body {
        /* margin: 0;
        padding: 0;
        overflow: hidden;*/
        background-color: #f0f0f0;
      }

      #container {
        border-style: solid;
        /* border-color: coral; */
      }
    </style>
  </head>
  <body>

    <h1>Title</h1>

    <h2>Step 1 - Load an image and mark known location</h2>
    <input type="file" name="inpfile" id="inpFile">
    <div id="container"></div>
    
    <h2>Step 2 - Mark know location on the map</h2>
    <p>Ca va etre cool...</p>

    <!-- Loading and marking the picture -->
    <script>     
      
      //
      // Set up the picture viewer/marker
      //
      var container = document.getElementById('container');
      var stage = new Konva.Stage({
        container: 'container',
        width: container.clientWidth,
        height: 100,
      });
      var picLayer = new Konva.Layer();
      var markerLayer = new Konva.Layer();
      stage.add(picLayer);
      stage.add(markerLayer);

      //
      // Let the user load a picture in the marking area.
      //
      const inpFile = document.getElementById("inpFile");
      inpFile.addEventListener("change", function() {
        // Remove any marker left
        markerLayer.destroyChildren();
        markerLayer.draw();
        // Load picture
        const file = this.files[0];
        if (!file) {
          return; // The user canceled
        }
        const reader = new FileReader();
        reader.addEventListener("load", function() {
          Konva.Image.fromURL(this.result, function (pic) {
            // Update dimension of the picture area
            stage.width(container.clientWidth);
            stage.height(container.clientWidth * pic.height() / pic.width());
            // Load picture in background
            pic.setAttrs({
              x: 0,
              y: 0,
              width: stage.width(),
              height: stage.height(),
            });
            picLayer.add(pic);
            picLayer.draw();
          });
        });
        reader.readAsDataURL(file);
      });      
      
      //
      // Detect left click on the picture to add a marker
      //      
      stage.on('click', function(e) {
        if (e.target.className == "Image" && e.evt.button == 0) {
          x = e.evt.layerX;
          y = e.evt.layerY;
          addPictureMarker(x, y);
        }
      });

      //
      // Detect right click on the picture to delete a marker
      //
      stage.on('contextmenu', function (e) {
        // prevent default behavior
        e.evt.preventDefault();
        if (e.target === stage || e.target.className == "Image") {
          return;
        };
        // move up in the hierarchy to (possibly) find a label element (rather than one of its subelement)
        curTarget = e.target;
        while (curTarget.className != "Label") {
          if (!curTarget.parent) {
            return;
          }
          curTarget = curTarget.parent;
        }
        removePictureMarker(curTarget);
      });

      //
      // Add a marker on the picture
      //
      function addPictureMarker(x, y) {
        console.log(`pictureMarker: ${x} / ${stage.width()}, ${y} / ${stage.height()}`)
        var tooltip = new Konva.Label({
          x: x,
          y: y,
          opacity: 0.75,
          draggable: true,
        });
        tooltip.add(
          new Konva.Tag({
            fill: 'black',
            pointerDirection: 'down',
            pointerWidth: 18,
            pointerHeight: 20,
          })
        );
        tooltip.add(
          new Konva.Text({
            text: "?",
            fontFamily: 'Calibri',
            fontSize: 18,
            padding: 5,
            fill: 'white',
          })
        );
        // add cursor styling and detect mouse over marker
        tooltip.on('mouseover', function () {
          document.body.style.cursor = 'pointer';
        });
        tooltip.on('mouseout', function () {
          document.body.style.cursor = 'default';
        });
        // Draw the marker
        markerLayer.add(tooltip);
        renameMarkers();
        markerLayer.draw();
        return tooltip;
      };
      
      //
      // Remove a marker from the picture
      //
      function removePictureMarker(marker) {
        marker.destroy();
        renameMarkers();
        markerLayer.draw();
      };
      
      //
      // Rename all markers from left to rigth
      //
      function renameMarkers() {
        let i = 0;
        let letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        markers = markerLayer.getChildren().slice(0);
        markers.sort(function (a, b) {
          return a.getPosition().x - b.getPosition().x;
        }).forEach(marker => {
          if (marker.getText()) {
            marker.getText().text(letters[i++]);
          };
        });
      };

    </script>


  </body>
</html>
