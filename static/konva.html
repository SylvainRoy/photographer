<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@7.2.3/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Drag and Drop Demo</title>
    <style>
      /* 
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
      */

      #container {
        border-style: solid;
        border-color: coral;
      }
    </style>
  </head>
  <body>

    <!-- 
    To do:

      - Markers should only appear in teh picture.
        - Add the code to load the picture live
        - remove all
     
    -->


    <h1>Title</h1>

    <h2>Step 1 - Load an image and mark known location</h2>
    <input type="file" name="inpfile" id="inpFile">
    <div id="container"></div>
    
    <h2>Step 2 - Mark know location on the map</h2>
    <p>Ca va etre cool...</p>

    <!-- Loading and marking the picture -->
    <script>     
      
      //
      // Set up the picture viewer/marker
      //
      var mouseovermarker = false;
      //var width = window.innerWidth;
      //var height = window.innerHeight;
      var container = document.getElementById('container');
      var stage = new Konva.Stage({
        container: 'container',
        width: container.clientWidth,
        height: 100, //container.clientHeight,
      });
      var layer = new Konva.Layer();
      stage.add(layer);

      //
      // Let the user load a picture in the marking area.
      //
      const inpFile = document.getElementById("inpFile");
      inpFile.addEventListener("change", function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.addEventListener("load", function() {
            stage.height(1000); //todo: this should adapt based on pic dimensions
            Konva.Image.fromURL(this.result, function (pic) {
              pic.setAttrs({
                x: 0,
                y: 0,
                width: container.clientWidth,
                height: container.clientWidth * pic.height() / pic.width(),
              });
              layer.add(pic);
              layer.batchDraw();
            });
          });
          reader.readAsDataURL(file);
        } else {
          // todo: No image selected, clean up...
          // - all markers to be erased
        };
      });      
      
      //
      // Detect click on the picture to add a marker
      //
      document.getElementById("container").addEventListener('click', onMouseUpdate, false);
      function onMouseUpdate(e) {
        if (!mouseovermarker) {
          x = e.offsetX;
          y = e.offsetY;
          addPictureMarker(x, y, `(${x}, ${y})`);
        };
      };      
      
      //
      // Add a marker on the picture
      //
      function addPictureMarker(x, y, text) {
        console.log(`pictureMarker: ${x} / ${stage.width()}, ${y} / ${stage.height()}`)
        var tooltip = new Konva.Label({
          x: x,
          y: y,
          opacity: 0.75,
          draggable: true,
        });
        tooltip.add(
          new Konva.Tag({
            fill: 'black',
            pointerDirection: 'down',
            pointerWidth: 10,
            pointerHeight: 30,
          })
        );
        tooltip.add(
          new Konva.Text({
            text: text,
            fontFamily: 'Calibri',
            fontSize: 18,
            padding: 5,
            fill: 'white',
          })
        );
        // add cursor styling and detect mouse over marker
        tooltip.on('mouseover', function () {
          document.body.style.cursor = 'pointer';
          mouseovermarker = true;
        });
        tooltip.on('mouseout', function () {
          document.body.style.cursor = 'default';
          mouseovermarker = false;
        });
        // Draw the marker
        layer.add(tooltip);
        layer.draw();
        return tooltip;
      };
      
      //
      // Remove a marker from the picture
      //
      function removePictureMarker(marker) {
        marker.destroy();
        layer.draw();
      };
      
    </script>


  </body>
</html>
