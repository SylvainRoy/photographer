<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@7.2.3/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Drag and Drop Demo</title>
    <style>
      /* 
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
      */

      #container {
        border-style: solid;
        border-color: coral;
      }
    </style>
  </head>
  <body>

    <!-- 
    To do:

      - Markers should only appear in teh picture.
        - Add the code to load the picture live
        - remove all
     
    -->


    <h1>Title</h1>

    <h2>Step 1 - Load an image and mark known location</h2>
    <input type="file" name="inpfile" id="inpFile">
    <div id="container"></div>
    
    <h2>Step 2 - Mark know location on the map</h2>
    <p>Ca va etre cool...</p>

    <!-- Loading and marking the picture -->
    <script>     
      
      //
      // Set up the picture viewer/marker
      //
      var container = document.getElementById('container');
      var stage = new Konva.Stage({
        container: 'container',
        width: container.clientWidth,
        height: 100, //container.clientHeight,
      });
      var picLayer = new Konva.Layer();
      var markerLayer = new Konva.Layer();
      stage.add(picLayer);
      stage.add(markerLayer);

      //
      // Let the user load a picture in the marking area.
      //
      const inpFile = document.getElementById("inpFile");
      inpFile.addEventListener("change", function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.addEventListener("load", function() {
            Konva.Image.fromURL(this.result, function (pic) {
              // Update dimension of the picture area
              stage.width(container.clientWidth);
              stage.height(container.clientWidth * pic.height() / pic.width());
              // Load picture in background
              pic.setAttrs({
                x: 0,
                y: 0,
                width: stage.width(),
                height: stage.height(),
              });
              picLayer.add(pic);
              picLayer.draw();
            });
          });
          reader.readAsDataURL(file);
        } else {
          // todo: No image selected, clean up...
          // - all markers to be erased
        };
      });      
      
      //
      // Detect left click on the picture to add a marker
      //      
      stage.on('click', function(e) {
        if (e.target === stage && e.evt.button == 0) {
          x = e.target.pointerPos.x;
          y = e.target.pointerPos.y;
          addPictureMarker(x, y, `(${x}, ${y})`);
        }
      });

      //
      // Detect right click on the picture to delete a marker
      //
      stage.on('contextmenu', function (e) {
        // prevent default behavior
        e.evt.preventDefault();
        if (e.target === stage) {
          return;
        };
        // move up in the hierarchy to find the parent label element (rather than just the text)
        curTarget = e.target;
        while (curTarget.className != "Label") {
          if (!curTarget.parent) {
            return;
          }
          curTarget = curTarget.parent;
        }
        removePictureMarker(curTarget);
      });

      //
      // Add a marker on the picture
      //
      function addPictureMarker(x, y, text) {
        console.log(`pictureMarker: ${x} / ${stage.width()}, ${y} / ${stage.height()}`)
        var tooltip = new Konva.Label({
          x: x,
          y: y,
          opacity: 0.75,
          draggable: true,
        });
        tooltip.add(
          new Konva.Tag({
            fill: 'black',
            pointerDirection: 'down',
            pointerWidth: 10,
            pointerHeight: 30,
          })
        );
        tooltip.add(
          new Konva.Text({
            text: text,
            fontFamily: 'Calibri',
            fontSize: 18,
            padding: 5,
            fill: 'white',
          })
        );
        // add cursor styling and detect mouse over marker
        tooltip.on('mouseover', function () {
          document.body.style.cursor = 'pointer';
        });
        tooltip.on('mouseout', function () {
          document.body.style.cursor = 'default';
        });
        // Draw the marker
        markerLayer.add(tooltip);
        markerLayer.draw();
        return tooltip;
      };
      
      //
      // Remove a marker from the picture
      //
      function removePictureMarker(marker) {
        marker.destroy();
        markerLayer.draw();
      };
      
    </script>


  </body>
</html>
